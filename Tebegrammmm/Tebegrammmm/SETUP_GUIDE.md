# Полная настройка Tebegram с LocalTunnel

## Описание изменений
Приложение Tebegram теперь полностью работает через публичный адрес сервера с использованием LocalTunnel. Клиенты больше не общаются напрямую друг с другом, а используют централизованный сервер.

## Ключевые особенности
- **Публичный адрес**: http://tebegrammmm.loca.lt (HTTP без SSL сертификатов)
- **Автоматический запуск LocalTunnel** из серверной папки
- **Централизованная отправка сообщений** через сервер
- **Мониторинг состояния туннеля** каждые 30 секунд
- **Автоматическая остановка LocalTunnel** при закрытии приложения

## Алгоритм работы
1. При запуске MessengerWindow:
   - Ищет `start_localtunnel.bat` в серверной папке
   - Создается публичный туннель http://tebegrammmm.loca.lt → localhost:5000
   - Запускается мониторинг состояния туннеля
   
2. При отправке сообщения:
   - Сообщение отправляется на `{serverAdress}/messages/send`
   - Сервер перенаправляет сообщение получателю
   - Все сообщения сохраняются в централизованной базе данных
   
3. При получении сообщений:
   - Клиент периодически опрашивает `{serverAdress}/messages/{UserLogin}`
   - Новые сообщения автоматически добавляются в интерфейс

## Установка и запуск

### Предварительные требования
1. **Node.js**: Скачайте и установите с https://nodejs.org/
2. **LocalTunnel**: Выполните в командной строке:
   ```bash
   npm install -g localtunnel
   ```

### Порядок запуска
1. **Запустите сервер** (ASP.NET Core) на порту 5000
2. **Запустите клиент** (WPF приложение)
   - LocalTunnel запустится автоматически
   - Через 5 секунд туннель будет доступен по адресу https://tebegrammmm.loca.lt

### Проверка работоспособности
- Откройте в браузере http://tebegrammmm.loca.lt/health
- Должен вернуться статус работы сервера

## Технические детали

### Файлы и изменения
- `MessengerWindow.xaml.cs`: Обновлена логика работы с сервером
- `TebegramServer/TebegramServer/start_localtunnel.bat`: Batch-файл для запуска туннеля
- `LOCALTUNNEL_README.md`: Подробная документация по LocalTunnel

### Новые методы в MessengerWindow
- `StartLocaltunnel()`: Автоматический запуск туннеля
- `StartTunnelMonitoring()`: Мониторинг состояния туннеля
- `CheckTunnelStatus()`: Проверка доступности туннеля
- `StopLocaltunnel()`: Корректная остановка туннеля

### API endpoints сервера
- `POST /messages/send`: Отправка сообщения
- `GET /messages/{userLogin}`: Получение сообщений пользователя
- `GET /users/online?user={username}`: Проверка онлайн статуса
- `GET /health`: Проверка состояния сервера

## Устранение проблем

### LocalTunnel не запускается
1. Проверьте установку Node.js: `node --version`
2. Проверьте установку LocalTunnel: `lt --version`
3. Переустановите LocalTunnel: `npm uninstall -g localtunnel && npm install -g localtunnel`

### Туннель недоступен
1. Проверьте, что сервер работает на порту 5000
2. Убедитесь, что порт 5000 не заблокирован фаерволом
3. Перезапустите приложение (туннель перезапустится автоматически)

### Сообщения не доходят
1. Проверьте логи в приложении (Log.Save)
2. Убедитесь, что сервер обрабатывает запросы на `/messages/send`
3. Проверьте, что оба клиента используют одинаковый serverAdress

## Безопасность
- LocalTunnel создает временный публичный URL
- Рекомендуется использовать HTTPS (уже настроено)
- При необходимости можно добавить аутентификацию на сервере

## Масштабирование
- Один туннель может обслуживать множество клиентов
- Сервер централизованно управляет всеми сообщениями
- Легко добавить новые функции (групповые чаты, файлы, уведомления)
