@echo off
chcp 65001 >nul
title üåê Universal LocalTunnel for Tebegram
color 0B
setlocal enabledelayedexpansion

echo.
echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë         üåê UNIVERSAL LOCALTUNNEL LAUNCHER      ‚ïë
echo ‚ïë                                                ‚ïë
echo ‚ïë  –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –õ–Æ–ë–û–ô URL –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç ‚ïë
echo ‚ïë  –µ–≥–æ –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤                         ‚ïë
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
echo.

REM –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä
echo üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 5000...
curl -s http://localhost:5000 >nul 2>&1
if errorlevel 1 (
    echo ‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 5000!
    echo    –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: dotnet run
    pause
    exit /b 1
)
echo ‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç

echo.
echo üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º LocalTunnel (–ø—Ä–∏–Ω–∏–º–∞–µ–º –ª—é–±–æ–π URL)...
echo üí° LocalTunnel –º–æ–∂–µ—Ç –≤—ã–¥–∞—Ç—å –ª—é–±–æ–π —Å—É–±–¥–æ–º–µ–Ω - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!
echo.

REM –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –≤—ã–≤–æ–¥–∞
set TUNNEL_LOG=%TEMP%\localtunnel_output.log
del "%TUNNEL_LOG%" 2>nul

echo ‚è≥ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å...
REM –ó–∞–ø—É—Å–∫–∞–µ–º lt –±–µ–∑ —Å—É–±–¥–æ–º–µ–Ω–∞ (—Å–ª—É—á–∞–π–Ω—ã–π URL)
start /b cmd /c "echo yes | lt --port 5000 > %TUNNEL_LOG% 2>&1"

REM –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è URL
set ATTEMPTS=0
:WAIT_FOR_URL
timeout /t 2 /nobreak >nul
set /a ATTEMPTS+=1

if exist "%TUNNEL_LOG%" (
    REM –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å URL
    for /f "tokens=*" %%i in ('findstr /c:"your url is" "%TUNNEL_LOG%" 2^>nul') do (
        set "TUNNEL_LINE=%%i"
        REM –ò–∑–≤–ª–µ–∫–∞–µ–º URL –∏–∑ —Å—Ç—Ä–æ–∫–∏ "your url is: https://..."
        for /f "tokens=4" %%u in ("!TUNNEL_LINE!") do (
            set "TUNNEL_URL=%%u"
            goto URL_FOUND
        )
    )
)

if %ATTEMPTS% LSS 15 (
    echo ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ URL... –ø–æ–ø—ã—Ç–∫–∞ %ATTEMPTS%/15
    goto WAIT_FOR_URL
)

echo ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL —Ç—É–Ω–Ω–µ–ª—è –∑–∞ 30 —Å–µ–∫—É–Ω–¥
pause
exit /b 1

:URL_FOUND
echo.
echo ‚úÖ –¢–£–ù–ù–ï–õ–¨ –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù!
echo üåê –ü–æ–ª—É—á–µ–Ω–Ω—ã–π URL: !TUNNEL_URL!

REM –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HTTPS –≤ HTTP –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
set "HTTP_URL=!TUNNEL_URL!"
set "HTTP_URL=!HTTP_URL:https://=http://!"

echo üîÑ HTTP –≤–µ—Ä—Å–∏—è: !HTTP_URL!

REM –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –≤ —Ñ–∞–π–ª –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
echo !HTTP_URL! > "%~dp0tunnel_url.txt"
echo üìù URL —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ tunnel_url.txt

REM –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
echo !HTTP_URL! > "%~dp0server_address.txt"

echo.
echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë                ‚úÖ –¢–£–ù–ù–ï–õ–¨ –ê–ö–¢–ò–í–ï–ù              ‚ïë
echo ‚ïë                                                ‚ïë
echo ‚ïë  üåê –õ–æ–∫–∞–ª—å–Ω—ã–π:  http://localhost:5000         ‚ïë
echo ‚ïë  üåç –ü—É–±–ª–∏—á–Ω—ã–π:  !HTTP_URL!          ‚ïë
echo ‚ïë                                                ‚ïë
echo ‚ïë  üìù –ê–¥—Ä–µ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª—ã:                    ‚ïë
echo ‚ïë     - tunnel_url.txt                           ‚ïë
echo ‚ïë     - server_address.txt                       ‚ïë
echo ‚ïë                                                ‚ïë
echo ‚ïë  ‚ö†Ô∏è  –ù–ï –ó–ê–ö–†–´–í–ê–ô–¢–ï –≠–¢–û –û–ö–ù–û!                   ‚ïë
echo ‚ïë  üì± –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—ã             ‚ïë
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
echo.

REM –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
echo üìã –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ö–õ–ò–ï–ù–¢–û–í:
echo    1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç Tebegram
echo    2. –ö–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
echo    3. –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª tunnel_url.txt
echo.
echo üìä –ù–∞—á–∏–Ω–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥...

:MONITOR
timeout /t 10 /nobreak >nul
echo ‚è∞ %date% %time% - –¢—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç

REM –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
curl -s http://localhost:5000 >nul 2>&1
if errorlevel 1 (
    echo ‚ùå –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!
    goto MONITOR
)

REM –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å
curl -s "!HTTP_URL!" >nul 2>&1
if errorlevel 1 (
    echo ‚ö†Ô∏è  –ü—É–±–ª–∏—á–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ø—Ä–æ–≤–µ—Ä—è–µ–º...
) else (
    echo ‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç
)

goto MONITOR
